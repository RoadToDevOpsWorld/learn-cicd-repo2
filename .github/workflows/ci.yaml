name: CI pipeline
on: workflow_dispatch
permissions:
  id-token: write # This is required for requesting the JWT
  contents: read # This is required for actions/checkout

jobs:
  build_publish:
    needs: testing
    runs-on: ubuntu-latest
    steps:
      - name: Code checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        id: aws-configuration
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          output-credentials: true

      - name: Build & Upload backend server image to ECR
        uses: kciter/aws-ecr-action@v5
        with:
          access_key_id: ${{ steps.aws-configuration.outputs.aws-access-key-id }}
          secret_access_key: ${{ steps.aws-configuration.outputs.aws-secret-access-key }}
          account_id: ${{ steps.aws-configuration.outputs.aws-account-id }}
          repo: ecr01
          create_repo: true
          region: us-east-1
          tags: latest
          dockerfile: ./src/templates/docker/Dockerfile
          path: ./src/templates/docker/
